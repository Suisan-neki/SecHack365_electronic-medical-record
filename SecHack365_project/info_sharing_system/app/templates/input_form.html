<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医療記録入力フォーム - SecHack365</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .input-form-container {
            max-width: 98%;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* 3行レイアウト（縦に積み重ね） */
        .three-column-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-section {
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }
        
        .form-section.minimized {
            padding: 15px 20px;
        }
        
        .form-section.minimized .form-group:not(.summary) {
            display: none;
        }
        
        .section-summary {
            display: none;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
            color: #2c3e50;
            cursor: pointer;
        }
        
        .section-summary:hover {
            background: #c8e6c9;
        }
        
        .form-section.minimized .section-summary {
            display: block;
        }
        
        .expand-icon {
            float: right;
            font-size: 14px;
        }
        
        /* 自動拡張テキストエリア */
        textarea.auto-expand {
            min-height: 40px;
            resize: none;
            overflow-y: hidden;
            transition: height 0.1s ease;
            line-height: 1.5;
            padding: 8px 12px;
            box-sizing: border-box;
        }
        
        /* 通常のテキストエリア（auto-expandでないもの）も調整 */
        textarea:not(.auto-expand) {
            min-height: 40px;
            line-height: 1.5;
            padding: 8px 12px;
            box-sizing: border-box;
        }
        
        /* 折りたたみ可能なカテゴリー */
        .collapsible-category {
            margin-bottom: 8px;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            transition: background 0.2s ease;
            user-select: none;
        }
        
        .category-header:hover {
            background: #e0e0e0;
        }
        
        .category-header strong {
            flex: 1;
            font-size: 12px;
        }
        
        .category-toggle {
            font-size: 16px;
            margin-right: 8px;
            transition: transform 0.2s ease;
        }
        
        .category-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .category-content {
            margin-top: 8px;
            display: block;
        }
        
        .category-content.collapsed {
            display: none;
        }
        
        /* プリセットボタン */
        .btn-preset {
            background: #fff;
            border: 1px solid #3498db;
            color: #3498db;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        
        .btn-preset:hover {
            background: #3498db;
            color: white;
        }
        
        /* 確定ボタンのスタイル */
        .btn-confirm {
            background: #95a5a6 !important;
            border: 1px solid #7f8c8d !important;
            color: white !important;
            transition: all 0.3s ease;
        }
        
        .btn-confirm.ready {
            background: #27ae60 !important;
            border: 1px solid #229954 !important;
        }
        
        .btn-confirm.ready:hover {
            background: #229954 !important;
        }
        
        .btn-confirm:disabled {
            background: #bdc3c7 !important;
            cursor: not-allowed;
        }
        
        .full-width-section {
            /* 特別なスタイルなし */
        }
        
        .form-section h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .char-counter {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }
        
        .char-counter.warning {
            color: #e67e22;
        }
        
        .char-counter.error {
            color: #e74c3c;
        }
        
        .required {
            color: #e74c3c;
        }
        
        .form-actions {
            text-align: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 30px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .preview-section {
            margin-top: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        
        .preview-section h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .error-message {
            color: #e74c3c;
            background: #fdf2f2;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .success-message {
            color: #27ae60;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        /* タグ選択UIのスタイル */
        .tag-categories {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tag-category {
            flex: 1;
            min-width: 200px;
        }
        
        .tag-category h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .tag-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .tag-button {
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            color: #2c3e50;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .tag-button:hover {
            background: #d5dbdb;
            border-color: #95a5a6;
        }
        
        .tag-button.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        /* 選択中のタグエリア */
        .selected-tags {
            min-height: 40px;
            padding: 10px;
            background: #e8f5e9;
            border: 2px dashed #4caf50;
            border-radius: 8px;
        }
        
        .selected-tags:empty::before {
            content: "タグを選択してください";
            color: #999;
            font-style: italic;
        }
        
        .selected-tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .selected-tag {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .selected-tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            opacity: 0.7;
        }
        
        .selected-tag .remove-tag:hover {
            opacity: 1;
        }
        
        /* 薬剤組み合わせ管理のスタイル */
        .medication-combination {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .medication-combination-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .medication-combination-title {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .medication-combination-remove {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .medication-combination-remove:hover {
            background: #c0392b;
        }
        
        .medication-combination-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .medication-combination-item {
            display: flex;
            flex-direction: column;
        }
        
        .medication-combination-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .medication-combination-item select,
        .medication-combination-item input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .medication-combination-preview {
            margin-top: 10px;
            padding: 8px;
            background: #e8f4f8;
            border-radius: 4px;
            font-size: 12px;
            color: #2c3e50;
        }
        
        .medication-combination-empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>医療記録入力フォーム</h1>
            <p>患者の医療情報を入力し、リアルタイムで患者に表示して同意を得ることができます。</p>
        </header>
        
        <!-- デバッグ情報 -->
        <script>
            console.log('フォーム読み込み完了:', new Date().toISOString());
        </script>
        
        <div class="input-form-container">
            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="success-message" class="success-message" style="display: none;"></div>
            
            <form id="medical-record-form">
                <!-- 3カラムレイアウト -->
                <div class="three-column-layout">
                    <!-- 症状・診断セクション -->
                    <div class="form-section" id="section-symptoms">
                        <h3>1. 症状・診断</h3>
                        
                        <!-- サマリー表示（折りたたみ時） -->
                        <div class="section-summary summary" id="summary-symptoms" onclick="expandSection('symptoms')">
                            <span class="expand-icon">▼ 展開</span>
                            <div id="summary-symptoms-text"></div>
                        </div>
                        
                        <!-- 症状プリセット -->
                        <div class="form-group">
                            <label>よく使う症状セット:</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                                <button type="button" class="btn btn-preset" onclick="applySymptomPreset('cold')">🤧 風邪症状</button>
                                <button type="button" class="btn btn-preset" onclick="applySymptomPreset('flu')">🤒 インフル症状</button>
                                <button type="button" class="btn btn-preset" onclick="applySymptomPreset('gastro')">🤢 胃腸炎症状</button>
                            </div>
                        </div>
                        
                        <!-- 症状タグ選択エリア（カテゴリー別・折りたたみ式） -->
                        <div class="form-group">
                            <label>症状タグ選択:</label>
                            
                            <div class="collapsible-category">
                                <div class="category-header" onclick="toggleCategory('cold')">
                                    <span class="category-toggle" id="toggle-cold">▼</span>
                                    <strong style="color: #e74c3c;">🤧 風邪・呼吸器系</strong>
                                </div>
                                <div class="category-content" id="content-cold">
                                    <div class="tag-buttons" id="symptom-tags-cold"></div>
                                </div>
                            </div>
                            
                            <div class="collapsible-category">
                                <div class="category-header" onclick="toggleCategory('pain')">
                                    <span class="category-toggle collapsed" id="toggle-pain">▼</span>
                                    <strong style="color: #e67e22;">💢 痛み系</strong>
                                </div>
                                <div class="category-content collapsed" id="content-pain">
                                    <div class="tag-buttons" id="symptom-tags-pain"></div>
                                </div>
                            </div>
                            
                            <div class="collapsible-category">
                                <div class="category-header" onclick="toggleCategory('gastro')">
                                    <span class="category-toggle collapsed" id="toggle-gastro">▼</span>
                                    <strong style="color: #f39c12;">🤢 消化器系</strong>
                                </div>
                                <div class="category-content collapsed" id="content-gastro">
                                    <div class="tag-buttons" id="symptom-tags-gastro"></div>
                                </div>
                            </div>
                            
                            <div class="collapsible-category">
                                <div class="category-header" onclick="toggleCategory('general')">
                                    <span class="category-toggle collapsed" id="toggle-general">▼</span>
                                    <strong style="color: #9b59b6;">😴 全身症状</strong>
                                </div>
                                <div class="category-content collapsed" id="content-general">
                                    <div class="tag-buttons" id="symptom-tags-general"></div>
                                </div>
                            </div>
                            
                            <div class="collapsible-category">
                                <div class="category-header" onclick="toggleCategory('cardio')">
                                    <span class="category-toggle collapsed" id="toggle-cardio">▼</span>
                                    <strong style="color: #e74c3c;">❤️ 循環器系</strong>
                                </div>
                                <div class="category-content collapsed" id="content-cardio">
                                    <div class="tag-buttons" id="symptom-tags-cardio"></div>
                                </div>
                            </div>
                            
                            <div class="collapsible-category">
                                <div class="category-header" onclick="toggleCategory('other')">
                                    <span class="category-toggle collapsed" id="toggle-other">▼</span>
                                    <strong style="color: #34495e;">📝 その他</strong>
                                </div>
                                <div class="category-content collapsed" id="content-other">
                                    <div class="tag-buttons" id="symptom-tags-other"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 選択中の症状タグ -->
                        <div class="form-group">
                            <label>選択中の症状:</label>
                            <div class="tag-buttons selected-tags" id="selected-symptom-tags">
                                <!-- 選択された症状タグがここに移動します -->
                            </div>
                            <button type="button" class="btn btn-secondary btn-confirm" id="confirm-symptoms-btn" onclick="confirmSymptoms()" style="margin-top: 10px;">
                                ✓ 症状を確定して説明文に追加
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="symptoms">症状の詳細 <span class="required">*</span></label>
                            <small style="color: #000; display: block; margin-bottom: 8px; font-weight: 500;">
                                💡 選択したタグをもとに、症状の詳細（いつから、程度、経過など）を記入してください。タグにない症状も自由に追記できます。
                            </small>
                            <textarea id="symptoms" name="symptoms" required maxlength="500" placeholder="例: 発熱（選択したタグ）→ 3日前から38.5度の発熱が続いている。解熱剤で一時的に下がるが再び上昇。頭痛（選択したタグ）→ 前頭部を中心に脈打つような痛み。" rows="1" class="auto-expand"></textarea>
                            <div class="char-counter" id="symptoms-counter">0/500</div>
                        </div>
                        
                        <hr style="border: none; border-top: 1px dashed #ccc; margin: 20px 0;">
                        
                        <div class="form-group">
                            <label for="diagnosis">診断名 <span class="required">*</span></label>
                            <small style="color: #000; display: block; margin-bottom: 8px; font-weight: 500;">
                                💡 正式な診断名を自由に入力してください（ICD-10コードも記載可能）。
                            </small>
                            <input type="text" id="diagnosis" name="diagnosis" required maxlength="200" placeholder="例: 急性上気道炎、インフルエンザ（A型）、急性胃腸炎など">
                            <div class="char-counter" id="diagnosis-counter">0/200</div>
                            <button type="button" class="btn btn-secondary btn-confirm" id="confirm-diagnosis-btn" onclick="confirmDiagnosis()" style="margin-top: 10px;">
                                ✓ 診断を確定して説明文に追加
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="diagnosis_details">診断詳細・所見</label>
                            <textarea id="diagnosis_details" name="diagnosis_details" maxlength="1000" placeholder="診断の詳細や所見を記入してください" rows="1" class="auto-expand"></textarea>
                            <div class="char-counter" id="diagnosis_details-counter">0/1000</div>
                        </div>
                    </div>

                    <!-- 処方薬セクション -->
                    <div class="form-section" id="section-medication">
                        <h3>2. 処方薬</h3>
                        
                        <!-- サマリー表示（折りたたみ時） -->
                        <div class="section-summary summary" id="summary-medication" onclick="expandSection('medication')">
                            <span class="expand-icon">▼ 展開</span>
                            <div id="summary-medication-text"></div>
                        </div>
                        
                        <!-- プリセット薬剤セット -->
                        <div class="form-group">
                            <label>よく使う処方セット:</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                                <button type="button" class="btn btn-preset" onclick="applyPreset('cold')">🤧 風邪セット</button>
                                <button type="button" class="btn btn-preset" onclick="applyPreset('flu')">🤒 インフルセット</button>
                                <button type="button" class="btn btn-preset" onclick="applyPreset('gastro')">🤢 胃腸炎セット</button>
                                <button type="button" class="btn btn-preset" onclick="applyPreset('allergy')">🤧 アレルギーセット</button>
                            </div>
                        </div>
                        
                        <!-- 薬剤組み合わせ管理エリア -->
                        <div class="form-group">
                            <label>薬剤組み合わせ管理:</label>
                            <div id="medication-combination-area">
                                <!-- 薬剤組み合わせがここに動的に挿入されます -->
                            </div>
                            <button type="button" class="btn btn-secondary" id="add-medication-btn" style="margin-top: 10px;">
                                + 新しい薬剤を追加
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="medication">処方薬・治療 <span class="required">*</span></label>
                            <small style="color: #000; display: block; margin-bottom: 8px; font-weight: 500;">
                                💡 上記の薬剤組み合わせで自動入力されます。タグにない薬剤や詳細も直接追記できます。
                            </small>
                            <input type="text" id="medication" name="medication" required maxlength="500" placeholder="例: カロナール 500mg 1日3回 3日分 食後、ムコダイン 500mg 1日3回 3日分 食後">
                            <div class="char-counter" id="medication-counter">0/500</div>
                            <button type="button" class="btn btn-secondary btn-confirm" id="confirm-medication-btn" onclick="confirmMedication()" style="margin-top: 10px;">
                                ✓ 処方薬を確定して説明文に追加
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="medication_instructions">服薬指導・注意事項</label>
                            <textarea id="medication_instructions" name="medication_instructions" maxlength="1000" placeholder="服薬方法や注意事項を記入してください" rows="1" class="auto-expand"></textarea>
                            <div class="char-counter" id="medication_instructions-counter">0/1000</div>
                        </div>
                    </div>
                </div>
                
                <!-- 治療計画・患者向け説明（全幅） -->
                <div class="form-section full-width-section">
                    <h3>3. 治療計画・患者向け説明</h3>
                    
                    <div class="form-group">
                        <label for="treatment_plan">治療方針・計画 <span class="required">*</span></label>
                        <textarea id="treatment_plan" name="treatment_plan" required maxlength="1000" placeholder="治療方針や計画を記入してください" rows="1" class="auto-expand"></textarea>
                        <div class="char-counter" id="treatment_plan-counter">0/1000</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="follow_up">フォローアップ予定</label>
                        <textarea id="follow_up" name="follow_up" maxlength="500" placeholder="次回の診察予定やフォローアップ内容を記入してください" rows="1" class="auto-expand"></textarea>
                        <div class="char-counter" id="follow_up-counter">0/500</div>
                    </div>
                    
                    <hr style="border: none; border-top: 1px dashed #ccc; margin: 20px 0;">
                    
                    <div class="form-group">
                        <label for="patient_explanation">患者向け説明文 <span class="required">*</span></label>
                        <small style="color: #000; display: block; margin-bottom: 8px; font-weight: 500;">
                            💡 各セクションの「確定」ボタンを押すと、段階的に説明文が追加されます。必要に応じて編集してください。
                        </small>
                        <textarea id="patient_explanation" name="patient_explanation" required maxlength="1500" placeholder="症状・診断・処方薬の「確定」ボタンを押すと、自動的に説明文が生成されます。" rows="1" class="auto-expand"></textarea>
                        <div class="char-counter" id="patient_explanation-counter">0/1500</div>
                    </div>
                </div>
                
                <!-- プレビューセクション -->
                <div class="preview-section" id="preview-section" style="display: none;">
                    <h4>入力内容プレビュー</h4>
                    <div id="preview-content"></div>
                </div>
                
                <!-- フォームアクション -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="preview-btn">プレビュー</button>
                    <button type="button" class="btn btn-primary" id="submit-btn">電子カルテに入力する</button>
                    <button type="button" class="btn btn-success" id="send-to-ehr-btn" style="display: none;">模擬カルテに送信</button>
                </div>
            </form>
            
            <div class="loading" id="loading">
                <p>処理中です...</p>
            </div>
        </div>
    </div>
    
    <script>
        // 文字数カウンター機能
        function setupCharCounter(inputId, counterId, maxLength) {
            const input = document.getElementById(inputId);
            const counter = document.getElementById(counterId);
            
            input.addEventListener('input', function() {
                const length = this.value.length;
                counter.textContent = `${length}/${maxLength}`;
                
                // 文字数に応じて色を変更
                counter.className = 'char-counter';
                if (length > maxLength * 0.9) {
                    counter.className += ' warning';
                }
                if (length > maxLength) {
                    counter.className += ' error';
                }
            });
        }
        
        // 各フィールドの文字数カウンターを設定
        setupCharCounter('symptoms', 'symptoms-counter', 500);
        setupCharCounter('diagnosis', 'diagnosis-counter', 200);
        setupCharCounter('diagnosis_details', 'diagnosis_details-counter', 1000);
        setupCharCounter('medication', 'medication-counter', 500);
        setupCharCounter('medication_instructions', 'medication_instructions-counter', 1000);
        setupCharCounter('treatment_plan', 'treatment_plan-counter', 1000);
        setupCharCounter('follow_up', 'follow_up-counter', 500);
        setupCharCounter('patient_explanation', 'patient_explanation-counter', 1500);
        
        // プレビュー機能
        document.getElementById('preview-btn').addEventListener('click', function() {
            const formData = new FormData(document.getElementById('medical-record-form'));
            const data = Object.fromEntries(formData.entries());
            
            const previewContent = `
                <h5>症状情報</h5>
                <p><strong>症状の詳細:</strong> ${data.symptoms || '未入力'}</p>
                
                <h5>診断情報</h5>
                <p><strong>診断名:</strong> ${data.diagnosis || '未入力'}</p>
                <p><strong>診断詳細:</strong> ${data.diagnosis_details || '未入力'}</p>
                
                <h5>処方情報</h5>
                <p><strong>処方薬:</strong> ${data.medication || '未入力'}</p>
                <p><strong>服薬指導:</strong> ${data.medication_instructions || '未入力'}</p>
                
                <h5>治療計画</h5>
                <p><strong>治療方針:</strong> ${data.treatment_plan || '未入力'}</p>
                <p><strong>フォローアップ:</strong> ${data.follow_up || '未入力'}</p>
                
                <h5>患者向け説明</h5>
                <p><strong>説明文:</strong> ${data.patient_explanation || '未入力'}</p>
            `;
            
            document.getElementById('preview-content').innerHTML = previewContent;
            document.getElementById('preview-section').style.display = 'block';
        });
        
        // フォーム送信処理（電子カルテに入力）
        const submitBtn = document.getElementById('submit-btn');
        if (submitBtn) {
            // 既存のイベントリスナーを削除
            submitBtn.removeEventListener('click', handleSubmitClick);
            
            // 新しいイベントリスナーを追加
            submitBtn.addEventListener('click', handleSubmitClick);
        }
        
        function handleSubmitClick() {
            alert('電子カルテに入力するボタンがクリックされました！');
            console.log('電子カルテに入力するボタンがクリックされました');
            
            const form = document.getElementById('medical-record-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            console.log('フォームデータ:', data);
            
            // 必須フィールドの検証（テスト用に緩和）
            const requiredFields = ['symptoms', 'diagnosis', 'medication'];
            const missingFields = requiredFields.filter(field => !data[field]);
            
            if (missingFields.length > 0) {
                console.log('必須フィールドが不足:', missingFields);
                showError(`必須フィールドが入力されていません: ${missingFields.join(', ')}`);
                return;
            }
            
            console.log('必須フィールドの検証を通過しました');
            
            // ローディング表示
            showLoading(true);
            hideMessages();
            
            // 患者用端末を起動
            startPatientDisplay(data);
            
            // データ送信
            fetch('/api/input_medical_record', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                console.log('API応答:', result);
                showLoading(false);
                if (result.success) {
                    showSuccess('医療記録が正常に保存されました。患者用端末に表示中です。');
                    // 模擬カルテ送信ボタンを表示
                    showSendToEhrButton();
                } else {
                    showError(result.error || '医療記録の保存に失敗しました。');
                }
            })
            .catch(error => {
                console.error('API送信エラー:', error);
                showLoading(false);
                showError('通信エラーが発生しました: ' + error.message);
            });
        }
        
        // ユーティリティ関数
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }
        
        function hideMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }
        
        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            if (show) {
                loadingDiv.classList.add('show');
            } else {
                loadingDiv.classList.remove('show');
            }
        }
        
        // タグ選択機能
        let selectedTags = [];
        let allTags = {};
        
        // 薬剤組み合わせ管理
        let medicationCombinations = [];
        let medicationCombinationCounter = 0;
        
        // 薬剤のデフォルト設定（よく使う用量・頻度）
        const medicationDefaults = {
            'カロナール': { dosage: '500mg', frequency: '1日3回', duration: '3日分', timing: '食後' },
            'ロキソニン': { dosage: '60mg', frequency: '1日3回', duration: '3日分', timing: '食後' },
            'ムコダイン': { dosage: '500mg', frequency: '1日3回', duration: '5日分', timing: '食後' },
            'カルボシステイン': { dosage: '500mg', frequency: '1日3回', duration: '5日分', timing: '食後' },
            'メジコン': { dosage: '15mg', frequency: '1日3回', duration: '5日分', timing: '食後' },
            'タミフル': { dosage: '75mg', frequency: '1日2回', duration: '5日分', timing: '食後' },
            'PL配合顆粒': { dosage: '1g', frequency: '1日3回', duration: '3日分', timing: '食後' },
            'ガスター': { dosage: '20mg', frequency: '1日2回', duration: '7日分', timing: '食後' },
            'ビオフェルミン': { dosage: '3錠', frequency: '1日3回', duration: '7日分', timing: '食後' },
            'アレロック': { dosage: '5mg', frequency: '1日2回', duration: '14日分', timing: '食後' },
        };
        
        // タグデータを読み込み
        async function loadTags() {
            try {
                const response = await fetch('/api/symptom_tags');
                const tags = await response.json();
                
                // カテゴリ別にタグを整理
                allTags = {
                    '症状-風邪': [],
                    '症状-痛み': [],
                    '症状-消化器': [],
                    '症状-全身': [],
                    '症状-循環器': [],
                    '症状-その他': [],
                    '薬剤名': [],
                    '用量': [],
                    '頻度': [],
                    '日数': [],
                    '服薬タイミング': []
                };
                
                tags.forEach(tag => {
                    if (allTags[tag.category]) {
                        allTags[tag.category].push(tag);
                    }
                });
                
                // タグボタンを生成
                updateSelectedTagsDisplay(); // タグを初期表示（選択エリアと元エリアに分ける）
            } catch (error) {
                console.error('タグの読み込みに失敗しました:', error);
            }
        }
        
        // タグの選択/選択解除（タグを移動させる）
        function toggleTag(tag, fromSelected = false) {
            const isSelected = selectedTags.some(t => t.tag_id === tag.tag_id);
            
            if (isSelected) {
                // 選択を解除 - 元のエリアに戻す
                selectedTags = selectedTags.filter(t => t.tag_id !== tag.tag_id);
            } else {
                // 選択 - 選択エリアに移動
                selectedTags.push(tag);
            }
            
            updateSelectedTagsDisplay();
            updateFormFields();
            updateConfirmButtonStates(); // ボタンの状態を更新
            clearExplanationIfEmpty(); // 症状タグがなくなったら説明文をクリア
        }
        
        // 確定ボタンの状態を更新
        function updateConfirmButtonStates() {
            console.log('=== ボタン状態更新 ===');
            
            // 症状ボタン
            const symptomBtn = document.getElementById('confirm-symptoms-btn');
            const symptomTags = selectedTags.filter(t => t.category && t.category.startsWith('症状'));
            console.log('症状タグ数:', symptomTags.length);
            if (symptomBtn) {
                if (symptomTags.length > 0) {
                    symptomBtn.classList.add('ready');
                    console.log('  → 症状ボタンを緑色に');
                } else {
                    symptomBtn.classList.remove('ready');
                    console.log('  → 症状ボタンを灰色に');
                }
            }
            
            // 診断ボタン
            const diagnosisBtn = document.getElementById('confirm-diagnosis-btn');
            const diagnosisField = document.getElementById('diagnosis');
            console.log('診断名:', diagnosisField ? diagnosisField.value : 'null');
            if (diagnosisBtn && diagnosisField) {
                if (diagnosisField.value.trim()) {
                    diagnosisBtn.classList.add('ready');
                    console.log('  → 診断ボタンを緑色に');
                } else {
                    diagnosisBtn.classList.remove('ready');
                    console.log('  → 診断ボタンを灰色に');
                }
            }
            
            // 処方薬ボタン
            const medicationBtn = document.getElementById('confirm-medication-btn');
            console.log('薬剤組み合わせ数:', medicationCombinations.length);
            if (medicationBtn) {
                if (medicationCombinations.length > 0) {
                    medicationBtn.classList.add('ready');
                    console.log('  → 処方薬ボタンを緑色に');
                } else {
                    medicationBtn.classList.remove('ready');
                    console.log('  → 処方薬ボタンを灰色に');
                }
            }
        }
        
        // 選択されたタグの表示を更新
        function updateSelectedTagsDisplay() {
            // カテゴリーマッピング
            const categoryMapping = {
                '症状-風邪': 'symptom-tags-cold',
                '症状-痛み': 'symptom-tags-pain',
                '症状-消化器': 'symptom-tags-gastro',
                '症状-全身': 'symptom-tags-general',
                '症状-循環器': 'symptom-tags-cardio',
                '症状-その他': 'symptom-tags-other'
            };
            
            // 選択中エリアをクリア
            const selectedContainer = document.getElementById('selected-symptom-tags');
            if (selectedContainer) {
                selectedContainer.innerHTML = '';
            }
            
            // 各カテゴリごとに処理
            Object.keys(categoryMapping).forEach(category => {
                const sourceContainerId = categoryMapping[category];
                const sourceContainer = document.getElementById(sourceContainerId);
                
                if (!sourceContainer) return;
                
                // 元のエリアをクリア
                sourceContainer.innerHTML = '';
                
                // このカテゴリのすべてのタグを取得
                const categoryTags = allTags[category] || [];
                
                categoryTags.forEach(tag => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'tag-button';
                    button.textContent = tag.tag_name;
                    button.dataset.tagId = tag.tag_id;
                    button.dataset.category = tag.category;
                    button.dataset.tagName = tag.tag_name;
                    
                    // 選択されているかチェック
                    const isSelected = selectedTags.some(t => t.tag_id === tag.tag_id);
                    
                    if (isSelected) {
                        // 選択中エリアに配置
                        button.classList.add('selected');
                        button.addEventListener('click', () => toggleTag(tag, true));
                        selectedContainer.appendChild(button);
                    } else {
                        // 元のエリアに配置
                        button.addEventListener('click', () => toggleTag(tag, false));
                        sourceContainer.appendChild(button);
                    }
                });
            });
            
            // ボタンの状態を更新
            updateConfirmButtonStates();
        }
        
        // カテゴリーの折りたたみ機能
        function toggleCategory(categoryId) {
            const toggle = document.getElementById(`toggle-${categoryId}`);
            const content = document.getElementById(`content-${categoryId}`);
            
            if (toggle && content) {
                toggle.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            }
        }
        
        // 段階的に説明文を追加する関数群
        function appendToExplanation(text) {
            const explanationField = document.getElementById('patient_explanation');
            const currentValue = explanationField.value;
            
            if (currentValue) {
                explanationField.value = currentValue + '\n\n' + text;
            } else {
                explanationField.value = text;
            }
            
            // 高さを調整
            explanationField.dispatchEvent(new Event('input'));
        }
        
        // セクションを折りたたむ
        function minimizeSection(sectionId, summaryText) {
            const section = document.getElementById(`section-${sectionId}`);
            const summaryElement = document.getElementById(`summary-${sectionId}-text`);
            
            if (section && summaryElement) {
                section.classList.add('minimized');
                summaryElement.textContent = summaryText;
                
                // 次のセクションにスクロール
                const nextSection = section.nextElementSibling;
                if (nextSection) {
                    nextSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }
        
        // セクションを展開
        function expandSection(sectionId) {
            const section = document.getElementById(`section-${sectionId}`);
            if (section) {
                section.classList.remove('minimized');
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // 症状タグがなくなった場合に説明文をクリア
        function clearExplanationIfEmpty() {
            const symptomTags = selectedTags.filter(t => t.category && t.category.startsWith('症状'));
            const diagnosisField = document.getElementById('diagnosis');
            const explanationField = document.getElementById('patient_explanation');
            
            // 症状タグがすべて削除された場合
            if (symptomTags.length === 0) {
                const lines = explanationField.value.split('\n\n').filter(line => line.trim());
                // 1文目（症状に関する文）を削除
                if (lines.length > 0 && lines[0].includes('といった症状で受診していただきました')) {
                    lines.shift(); // 最初の行を削除
                    explanationField.value = lines.join('\n\n');
                    explanationField.dispatchEvent(new Event('input'));
                }
            }
            
            // 診断名が削除された場合
            if (!diagnosisField.value.trim()) {
                const lines = explanationField.value.split('\n\n').filter(line => line.trim());
                // 2文目（診断に関する文）を削除
                const diagnosisLineIndex = lines.findIndex(line => line.includes('と診断いたしました'));
                if (diagnosisLineIndex !== -1) {
                    lines.splice(diagnosisLineIndex, 1);
                    explanationField.value = lines.join('\n\n');
                    explanationField.dispatchEvent(new Event('input'));
                }
            }
            
            // 処方薬がすべて削除された場合
            if (medicationCombinations.length === 0) {
                const lines = explanationField.value.split('\n\n').filter(line => line.trim());
                // 処方薬に関する文を削除
                const medicationLineIndex = lines.findIndex(line => line.includes('処方薬は') && line.includes('種類を'));
                if (medicationLineIndex !== -1) {
                    // 処方薬の文と、それに続く再受診の文、お大事にの文を削除
                    lines.splice(medicationLineIndex, 3);
                    explanationField.value = lines.join('\n\n');
                    explanationField.dispatchEvent(new Event('input'));
                }
            }
        }
        
        // ステップ1: 症状を確定
        function confirmSymptoms() {
            const symptomTags = selectedTags.filter(t => t.category.startsWith('症状'));
            const symptomNames = symptomTags.map(t => t.tag_name);
            
            if (symptomNames.length === 0) {
                alert('症状タグを選択してください。');
                return;
            }
            
            const text = `「${symptomNames.join('」「')}」といった症状で受診していただきました。`;
            
            // 説明文の1文目として設定（置き換え）
            const explanationField = document.getElementById('patient_explanation');
            const lines = explanationField.value.split('\n\n');
            lines[0] = text;
            explanationField.value = lines.join('\n\n');
            
            explanationField.dispatchEvent(new Event('input'));
            
            // セクションを折りたたんで次へ
            const diagnosisField = document.getElementById('diagnosis');
            const diagnosis = diagnosisField.value || '（未入力）';
            minimizeSection('symptoms', `✅ 症状: ${symptomNames.join('、')} / 診断: ${diagnosis}`);
        }
        
        // ステップ2: 診断を確定
        function confirmDiagnosis() {
            const diagnosisField = document.getElementById('diagnosis');
            const diagnosis = diagnosisField.value;
            
            if (!diagnosis) {
                alert('診断名を入力してください。');
                return;
            }
            
            const text = `これらの症状から「${diagnosis}」と診断いたしました。`;
            
            // 説明文の2文目として設定
            const explanationField = document.getElementById('patient_explanation');
            const lines = explanationField.value.split('\n\n').filter(line => line.trim());
            
            if (lines.length >= 2) {
                lines[1] = text;
            } else {
                lines.push(text);
            }
            
            explanationField.value = lines.join('\n\n');
            explanationField.dispatchEvent(new Event('input'));
            
            // 症状・診断セクションのサマリーを更新して折りたたむ
            const symptomTags = selectedTags.filter(t => t.category.startsWith('症状'));
            const symptomNames = symptomTags.map(t => t.tag_name);
            minimizeSection('symptoms', `✅ 症状: ${symptomNames.join('、')} / 診断: ${diagnosis}`);
        }
        
        // ステップ3: 処方薬を確定
        function confirmMedication() {
            const medicationCount = medicationCombinations.length;
            
            if (medicationCount === 0) {
                alert('処方薬を追加してください。');
                return;
            }
            
            let maxDuration = 0;
            medicationCombinations.forEach(med => {
                if (med.duration) {
                    const match = med.duration.match(/(\d+)日分/);
                    if (match) {
                        maxDuration = Math.max(maxDuration, parseInt(match[1]));
                    }
                }
            });
            
            const text = `処方薬は${medicationCount}種類を${maxDuration > 0 ? maxDuration : 'ー'}日分お出しします。\n\n症状が治まらない場合や悪化する場合は、お早めに再受診してください。\n\nお大事になさってください。`;
            
            // 説明文の3文目以降として設定
            const explanationField = document.getElementById('patient_explanation');
            const lines = explanationField.value.split('\n\n').filter(line => line.trim());
            
            // 3文目以降を置き換え
            lines[2] = text.split('\n\n')[0];
            lines[3] = text.split('\n\n')[1];
            lines[4] = text.split('\n\n')[2];
            
            explanationField.value = lines.join('\n\n');
            explanationField.dispatchEvent(new Event('input'));
            
            // セクションを折りたたんで次へ
            const medicationField = document.getElementById('medication');
            const medicationSummary = medicationField.value.substring(0, 50) + (medicationField.value.length > 50 ? '...' : '');
            minimizeSection('medication', `✅ 処方: ${medicationSummary}`);
        }
        
        // 症状プリセットを適用
        function applySymptomPreset(presetType) {
            const presets = {
                'cold': ['発熱', '咳', '鼻水', 'のどの痛み'],
                'flu': ['発熱', '悪寒', '頭痛', '筋肉痛', 'だるさ'],
                'gastro': ['腹痛', '下痢', '吐き気', '嘔吐']
            };
            
            const symptomNames = presets[presetType];
            if (symptomNames) {
                // 既存の症状選択をクリア
                selectedTags = selectedTags.filter(t => !t.category.startsWith('症状'));
                
                // プリセットの症状を選択
                Object.keys(allTags).forEach(category => {
                    if (category.startsWith('症状')) {
                        allTags[category].forEach(tag => {
                            if (symptomNames.includes(tag.tag_name) && !selectedTags.some(t => t.tag_id === tag.tag_id)) {
                                selectedTags.push(tag);
                            }
                        });
                    }
                });
                
                updateSelectedTagsDisplay();
                updateFormFields();
                updateConfirmButtonStates(); // ボタンの状態を更新
                clearExplanationIfEmpty(); // 症状が変更されたら説明文を確認
            }
        }
        
        // フォームフィールドを更新（タグ選択に基づいて自動入力）
        function updateFormFields() {
            // 症状タグは選択するだけで、詳細フィールドには自動入力しない
            // 医師が手動で詳細を記入する
        }
        
        // 案2: プリセット処方セットを適用
        function applyPreset(presetType) {
            medicationCombinations = []; // 既存をクリア
            medicationCombinationCounter = 0;
            
            const presets = {
                'cold': [
                    { name: 'カロナール', dosage: '500mg', frequency: '1日3回', duration: '3日分', timing: '食後' },
                    { name: 'PL配合顆粒', dosage: '1g', frequency: '1日3回', duration: '3日分', timing: '食後' },
                    { name: 'ムコダイン', dosage: '500mg', frequency: '1日3回', duration: '5日分', timing: '食後' }
                ],
                'flu': [
                    { name: 'タミフル', dosage: '75mg', frequency: '1日2回', duration: '5日分', timing: '食後' },
                    { name: 'カロナール', dosage: '500mg', frequency: '1日3回', duration: '3日分', timing: '食後' }
                ],
                'gastro': [
                    { name: 'ナウゼリン', dosage: '10mg', frequency: '1日3回', duration: '3日分', timing: '食前' },
                    { name: 'ビオフェルミン', dosage: '3錠', frequency: '1日3回', duration: '7日分', timing: '食後' }
                ],
                'allergy': [
                    { name: 'アレロック', dosage: '5mg', frequency: '1日2回', duration: '14日分', timing: '食後' }
                ]
            };
            
            const preset = presets[presetType];
            if (preset) {
                preset.forEach(med => {
                    const combinationId = `medication-${medicationCombinationCounter++}`;
                    medicationCombinations.push({
                        id: combinationId,
                        ...med
                    });
                });
                renderMedicationCombinations();
                updateMedicationField();
                updateConfirmButtonStates(); // ボタンの状態を更新
            }
        }
        
        // 薬剤組み合わせ管理関数
        function addMedicationCombination() {
            const combinationId = `medication-${medicationCombinationCounter++}`;
            const combination = {
                id: combinationId,
                name: '',
                dosage: '',
                frequency: '',
                duration: '',
                timing: ''
            };
            
            medicationCombinations.push(combination);
            renderMedicationCombinations();
            updateConfirmButtonStates(); // ボタンの状態を更新
        }
        
        function removeMedicationCombination(combinationId) {
            medicationCombinations = medicationCombinations.filter(c => c.id !== combinationId);
            renderMedicationCombinations();
            updateMedicationField();
            updateConfirmButtonStates(); // ボタンの状態を更新
            clearExplanationIfEmpty(); // 薬剤がすべて削除されたら説明文をクリア
        }
        
        function updateMedicationCombination(combinationId, field, value) {
            const combination = medicationCombinations.find(c => c.id === combinationId);
            if (combination) {
                combination[field] = value;
                
                // 案3: 薬剤名を選んだら、デフォルト値を自動入力
                if (field === 'name' && value && medicationDefaults[value]) {
                    const defaults = medicationDefaults[value];
                    combination.dosage = defaults.dosage;
                    combination.frequency = defaults.frequency;
                    combination.duration = defaults.duration;
                    combination.timing = defaults.timing;
                    // 再レンダリングして選択状態を反映
                    renderMedicationCombinations();
                    return;
                }
                
                updateMedicationCombinationPreview(combinationId);
                updateMedicationField();
            }
        }
        
        function updateMedicationCombinationPreview(combinationId) {
            const combination = medicationCombinations.find(c => c.id === combinationId);
            if (combination) {
                const preview = document.querySelector(`[data-combination-id="${combinationId}"] .medication-combination-preview`);
                if (preview) {
                    const parts = [];
                    if (combination.name) parts.push(combination.name);
                    if (combination.dosage) parts.push(combination.dosage);
                    if (combination.frequency) parts.push(combination.frequency);
                    if (combination.duration) parts.push(combination.duration);
                    if (combination.timing) parts.push(combination.timing);
                    
                    preview.textContent = parts.join(' ') || '薬剤情報を入力してください';
                }
            }
        }
        
        function renderMedicationCombinations() {
            const container = document.getElementById('medication-combination-area');
            
            if (medicationCombinations.length === 0) {
                container.innerHTML = '<div class="medication-combination-empty">薬剤を追加してください</div>';
                return;
            }
            
            container.innerHTML = medicationCombinations.map(combination => `
                <div class="medication-combination" data-combination-id="${combination.id}">
                    <div class="medication-combination-header">
                        <div class="medication-combination-title">薬剤 ${medicationCombinations.indexOf(combination) + 1}</div>
                        <button type="button" class="medication-combination-remove" onclick="removeMedicationCombination('${combination.id}')">
                            削除
                        </button>
                    </div>
                    <div class="medication-combination-content">
                        <div class="medication-combination-item">
                            <label>薬剤名</label>
                            <select onchange="updateMedicationCombination('${combination.id}', 'name', this.value)">
                                <option value="">選択してください</option>
                                ${allTags['薬剤名'] ? allTags['薬剤名'].map(tag => 
                                    `<option value="${tag.tag_name}" ${combination.name === tag.tag_name ? 'selected' : ''}>${tag.tag_name}</option>`
                                ).join('') : ''}
                            </select>
                        </div>
                        <div class="medication-combination-item">
                            <label>用量</label>
                            <select onchange="updateMedicationCombination('${combination.id}', 'dosage', this.value)">
                                <option value="">選択してください</option>
                                ${allTags['用量'] ? allTags['用量'].map(tag => 
                                    `<option value="${tag.tag_name}" ${combination.dosage === tag.tag_name ? 'selected' : ''}>${tag.tag_name}</option>`
                                ).join('') : ''}
                            </select>
                        </div>
                        <div class="medication-combination-item">
                            <label>頻度</label>
                            <select onchange="updateMedicationCombination('${combination.id}', 'frequency', this.value)">
                                <option value="">選択してください</option>
                                ${allTags['頻度'] ? allTags['頻度'].map(tag => 
                                    `<option value="${tag.tag_name}" ${combination.frequency === tag.tag_name ? 'selected' : ''}>${tag.tag_name}</option>`
                                ).join('') : ''}
                            </select>
                        </div>
                        <div class="medication-combination-item">
                            <label>日数</label>
                            <select onchange="updateMedicationCombination('${combination.id}', 'duration', this.value)">
                                <option value="">選択してください</option>
                                ${allTags['日数'] ? allTags['日数'].map(tag => 
                                    `<option value="${tag.tag_name}" ${combination.duration === tag.tag_name ? 'selected' : ''}>${tag.tag_name}</option>`
                                ).join('') : ''}
                            </select>
                        </div>
                        <div class="medication-combination-item">
                            <label>服薬タイミング</label>
                            <select onchange="updateMedicationCombination('${combination.id}', 'timing', this.value)">
                                <option value="">選択してください</option>
                                ${allTags['服薬タイミング'] ? allTags['服薬タイミング'].map(tag => 
                                    `<option value="${tag.tag_name}" ${combination.timing === tag.tag_name ? 'selected' : ''}>${tag.tag_name}</option>`
                                ).join('') : ''}
                            </select>
                        </div>
                        <div class="medication-combination-item">
                            <label>カスタム入力</label>
                            <input type="text" placeholder="追加情報" onchange="updateMedicationCombination('${combination.id}', 'custom', this.value)">
                        </div>
                    </div>
                    <div class="medication-combination-preview">
                        ${combination.name || combination.dosage || combination.frequency || combination.duration || combination.timing ? 
                            [combination.name, combination.dosage, combination.frequency, combination.duration, combination.timing].filter(Boolean).join(' ') : 
                            '薬剤情報を入力してください'}
                    </div>
                </div>
            `).join('');
        }
        
        function updateMedicationField() {
            const medicationField = document.getElementById('medication');
            const medicationTexts = medicationCombinations.map(combination => {
                const parts = [];
                if (combination.name) parts.push(combination.name);
                if (combination.dosage) parts.push(combination.dosage);
                if (combination.frequency) parts.push(combination.frequency);
                if (combination.duration) parts.push(combination.duration);
                if (combination.timing) parts.push(combination.timing);
                return parts.join(' ');
            }).filter(Boolean);
            
            medicationField.value = medicationTexts.join('、');
        }
        
        // ページ読み込み時にタグを読み込み
        // テキストエリアの自動拡張機能
        function setupAutoExpandTextarea(textarea) {
            if (!textarea) return;
            
            function adjustHeight() {
                // 一旦高さをリセット
                textarea.style.height = 'auto';
                // スクロール高さに基づいて新しい高さを設定
                const newHeight = Math.max(40, textarea.scrollHeight);
                textarea.style.height = newHeight + 'px';
            }
            
            textarea.addEventListener('input', adjustHeight);
            textarea.addEventListener('change', adjustHeight);
            // キーボードイベントでも調整
            textarea.addEventListener('keydown', function(e) {
                setTimeout(adjustHeight, 0);
            });
            // 初期化時にも実行
            setTimeout(adjustHeight, 0);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadTags();
            
            // デフォルトでは薬剤を表示しない（空の状態から始める）
            renderMedicationCombinations();
            
            // 薬剤追加ボタンのイベントリスナー
            document.getElementById('add-medication-btn').addEventListener('click', addMedicationCombination);
            
            // 診断フィールドの入力監視
            const diagnosisField = document.getElementById('diagnosis');
            if (diagnosisField) {
                diagnosisField.addEventListener('input', function() {
                    updateConfirmButtonStates();
                    clearExplanationIfEmpty(); // 診断が削除されたら説明文をクリア
                });
            }
            
            // 自動拡張テキストエリアの設定
            document.querySelectorAll('textarea.auto-expand').forEach(textarea => {
                setupAutoExpandTextarea(textarea);
            });
            
            // 初期状態のボタン更新
            updateConfirmButtonStates();
            
            // ボタンの状態を確認
            const submitBtn = document.getElementById('submit-btn');
            console.log('submit-btn要素:', submitBtn);
            console.log('submit-btnのdisabled状態:', submitBtn.disabled);
            console.log('submit-btnのclassList:', submitBtn.classList);
            
            // ボタンがクリック可能かテスト
            if (submitBtn) {
                // ボタンを強制的に有効化
                submitBtn.disabled = false;
                submitBtn.style.pointerEvents = 'auto';
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                
                // ボタンの状態をログ出力
                console.log('ボタン状態:', {
                    disabled: submitBtn.disabled,
                    style: submitBtn.style.cssText,
                    classList: submitBtn.classList.toString()
                });
                
                // クリックテスト用のイベントリスナー
                submitBtn.addEventListener('click', function(e) {
                    console.log('テスト用ボタンクリック:', e);
                    alert('テスト用ボタンがクリックされました！');
                });
            }
            
            // リアルタイム更新のイベントリスナーを追加
            const formFields = ['symptoms', 'diagnosis', 'medication', 'treatment_plan', 'patient_explanation'];
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        // デバウンス処理（500ms後に実行）
                        clearTimeout(window.updateTimeout);
                        window.updateTimeout = setTimeout(() => {
                            updatePatientDisplay();
                        }, 500);
                    });
                }
            });
        });

        // 模擬カルテに送信する機能
        document.getElementById('send-to-ehr-btn').addEventListener('click', async function() {
            const form = document.getElementById('medical-record-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // 現在の患者IDを取得（セッションから）
            const currentPatientId = sessionStorage.getItem('currentPatientId') || 'P001';
            
            // 診療記録データを準備
            const recordData = {
                patient_id: currentPatientId,
                date: new Date().toISOString(),
                doctor: '医師',
                department: '内科',
                chief_complaint: data.symptoms || '',
                diagnosis: data.diagnosis || '',
                treatment: data.medication || '',
                notes: data.patient_explanation || ''
            };
            
            try {
                const response = await fetch('/api/dummy-ehr/record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(recordData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ 診療記録を模擬カルテに送信しました！');
                    // ボタンを無効化
                    this.disabled = true;
                    this.textContent = '送信完了';
                } else {
                    alert('❌ 送信に失敗しました: ' + result.error);
                }
            } catch (error) {
                console.error('送信エラー:', error);
                alert('❌ 送信中にエラーが発生しました: ' + error.message);
            }
        });

        // 患者用端末を起動
        function startPatientDisplay(data) {
            // 患者用端末にデータを送信
            fetch('/api/set-patient-display', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    patient_id: sessionStorage.getItem('currentPatientId') || 'P001',
                    symptoms: data.symptoms,
                    diagnosis: data.diagnosis,
                    medication: data.medication,
                    treatment_plan: data.treatment_plan,
                    patient_explanation: data.patient_explanation,
                    status: 'displaying'
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    console.log('患者用端末にデータを送信しました');
                    // 患者用端末のURLを新しいタブで開く
                    const patientUrl = `/patient_display?patient_id=${sessionStorage.getItem('currentPatientId') || 'P001'}`;
                    window.open(patientUrl, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
                } else {
                    console.error('患者用端末への送信に失敗しました:', result.error);
                }
            })
            .catch(error => {
                console.error('患者用端末への送信エラー:', error);
            });
        }

        // リアルタイムで患者用端末を更新
        function updatePatientDisplay() {
            const form = document.getElementById('medical-record-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // 患者用端末にデータを送信
            fetch('/api/set-patient-display', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    patient_id: sessionStorage.getItem('currentPatientId') || 'P001',
                    symptoms: data.symptoms,
                    diagnosis: data.diagnosis,
                    medication: data.medication,
                    treatment_plan: data.treatment_plan,
                    patient_explanation: data.patient_explanation,
                    status: 'updating'
                })
            })
            .catch(error => {
                console.error('患者用端末の更新エラー:', error);
            });
        }

        // 患者同意後に送信ボタンを表示
        function showSendToEhrButton() {
            const sendBtn = document.getElementById('send-to-ehr-btn');
            sendBtn.style.display = 'inline-block';
        }
    </script>
</body>
</html>
