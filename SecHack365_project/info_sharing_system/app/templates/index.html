<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- åŸºæœ¬ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ºç™‚ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤</title>
    
    <!-- ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='accessibility.css') }}">
    
    <!-- æ‚£è€…é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« -->
    <style>
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            opacity: 0.7;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 20px;
            text-align: right;
            border-top: 1px solid #e0e0e0;
        }
        
        .patient-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .patient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .patient-item:hover {
            background: #f0f8ff;
            border-color: #667eea;
        }
        
        .patient-info h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 16px;
        }
        
        .patient-info p {
            margin: 2px 0;
            color: #666;
            font-size: 14px;
        }
        
        .patient-actions {
            margin-left: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
    </style>
</head>
<body {% if current_user.is_authenticated %}data-user-role="{{ current_user.role }}"{% endif %}>
    <!-- ======================================== -->
    <!-- åŒ»å¸«å‘ã‘ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ -->
    <!-- ======================================== -->
    <div id="private-view">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="user-header">
            <!-- å·¦å´: ã‚·ã‚¹ãƒ†ãƒ åã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
            <div class="user-info">
                <h2>æ‚£è€…æƒ…å ±å…±æœ‰ã‚·ã‚¹ãƒ†ãƒ </h2>
                {% if current_user.is_authenticated %}
                <p class="user-status">
                    ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <strong>{{ current_user.id }}</strong> 
                    ({{ current_user.role }})
                    {% if current_user.mfa_enabled %}
                    <span class="mfa-badge">MFAæœ‰åŠ¹</span>
                    {% endif %}
                </p>
                {% else %}
                <p class="user-status">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>
                {% endif %}
            </div>
            <!-- å³å´: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -->
            <div class="user-actions">
                <!-- ç¾åœ¨æ™‚åˆ»è¡¨ç¤º -->
                <div class="header-info">
                    <div id="current-time">ç¾åœ¨æ™‚åˆ»: èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <!-- ãƒšãƒ¼ã‚¸æ›´æ–°ãƒœã‚¿ãƒ³ -->
                <button onclick="location.reload()" class="refresh-btn">ğŸ”„ æ›´æ–°</button>
                <!-- èªè¨¼çŠ¶æ…‹ã«å¿œã˜ãŸãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                {% if current_user.is_authenticated %}
                    <!-- ç®¡ç†è€…ãƒ»åŒ»å¸«å‘ã‘æ©Ÿèƒ½ -->
                    {% if current_user.role == 'admin' or current_user.role == 'doctor' %}
                    <a href="{{ url_for('audit_dashboard') }}" class="nav-btn audit-btn">ğŸ” ç›£æŸ»ãƒ­ã‚°</a>
                    {% endif %}
                    <!-- èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘æ©Ÿèƒ½ -->
                    <a href="{{ url_for('webauthn_management') }}" class="nav-btn webauthn-btn">ğŸ”§ WebAuthnç®¡ç†</a>
                    <a href="{{ url_for('logout') }}" class="nav-btn logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                {% else %}
                    <!-- æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘æ©Ÿèƒ½ -->
                    <a href="{{ url_for('webauthn_login') }}" class="nav-btn webauthn-login-btn">ğŸ” WebAuthn</a>
                    <a href="{{ url_for('login') }}" class="nav-btn login-btn">ãƒ­ã‚°ã‚¤ãƒ³</a>
                {% endif %}
            </div>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ« -->
        <h1>ğŸ©º åŒ»å¸«å‘ã‘ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ - æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼</h1>
        
        <!-- ======================================== -->
        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <!-- ======================================== -->
        <div style="background: #f0f8ff; border: 1px solid #bee3f8; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 10px 0; color: #2b6cb0;">èªè¨¼çŠ¶æ…‹ï¼ˆãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼‰</h3>
            <p style="margin: 5px 0; color: #2c5282;">
                <strong>èªè¨¼çŠ¶æ…‹:</strong> 
                {% if current_user.is_authenticated %}
                    âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
                {% else %}
                    âŒ æœªãƒ­ã‚°ã‚¤ãƒ³
                {% endif %}
            </p>
            {% if current_user.is_authenticated %}
            <p style="margin: 5px 0; color: #2c5282;">
                <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> {{ current_user.id }}<br>
                <strong>å½¹å‰²:</strong> {{ current_user.role }}
            </p>
            {% endif %}
        </div>
        
        <!-- å¤ã„èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ ã¯æ–°ã—ã„ãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã—ãŸ -->
        <div id="auth-section" style="display: none;">
            <!-- éè¡¨ç¤º: æ–°ã—ã„Flask-Loginã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ -->
        </div>
        
        <!-- å¤ã„ãƒ˜ãƒƒãƒ€ãƒ¼ã¯å‰Šé™¤ï¼ˆä¸Šã®æ–°ã—ã„ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ç”¨ï¼‰ -->
        
        <div id="controls-section" style="display:block;">
            <!-- ã€æœ€é‡è¦ã€‘ç¾åœ¨ã®è¨ºå¯Ÿæ‚£è€…æƒ…å ± - å¤§ã‚µã‚¤ã‚º -->
            <div class="patient-card priority-high">
                <div class="card-header">
                    <h2>ğŸ¥ ç¾åœ¨ã®è¨ºå¯Ÿæ‚£è€…</h2>
                    <div class="patient-status">æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼ã§åŒ»ç™‚è¨˜éŒ²ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                </div>
                <div class="patient-details">
                    <div class="patient-detail-item">
                        <span class="detail-label">æ‚£è€…å</span>
                        <span class="detail-value" id="doctor-patient-name">ã€ŒåŒ»ç™‚è¨˜éŒ²ã‚’å…¥åŠ›ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹</span>
                    </div>
                    <div class="patient-detail-item">
                        <span class="detail-label">å¹´é½¢ãƒ»æ€§åˆ¥</span>
                        <span class="detail-value">
                            <span id="doctor-patient-age">-</span> / <span id="doctor-patient-gender">-</span>
                        </span>
                    </div>
                    <div class="patient-detail-item">
                        <span class="detail-label">æ‚£è€…ID</span>
                        <span class="detail-value" id="doctor-patient-id">-</span>
                    </div>
                </div>
            </div>
            
            <!-- ======================================== -->
            <!-- ä¸»è¦æ“ä½œãƒœã‚¿ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - æ¨ªä¸¦ã³3ã¤ -->
            <!-- ======================================== -->
            <div class="action-buttons priority-high">
                <div class="button-row">
                    <!-- åŒ»ç™‚è¨˜éŒ²å…¥åŠ›ãƒœã‚¿ãƒ³: æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼ã§åŒ»ç™‚æƒ…å ±ã‚’å…¥åŠ› -->
                    <a href="{{ url_for('input_form') }}" class="primary-action-button" id="input-form-btn">
                        <span class="button-icon">ğŸ“</span>
                        <span class="button-text">
                            <strong>åŒ»ç™‚è¨˜éŒ²ã‚’å…¥åŠ›</strong>
                            <small>æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼ã§åŒ»ç™‚æƒ…å ±ã‚’å…¥åŠ›ãƒ»æ‚£è€…ã«è¡¨ç¤º</small>
                        </span>
                    </a>
                    <!-- æ‚£è€…æƒ…å ±æŠ½å‡ºãƒœã‚¿ãƒ³: æ¨¡æ“¬é›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— -->
                    <button onclick="showPatientSelectionModal()" class="primary-action-button secondary" id="load-data-btn">
                        <span class="button-icon">ğŸ“¤</span>
                        <span class="button-text">
                            <strong>æ‚£è€…æƒ…å ±ã‚’æŠ½å‡º</strong>
                            <small>æ¨¡æ“¬é›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠãƒ»å–å¾—</small>
                        </span>
                    </button>
                    <!-- æ‚£è€…ç”¨ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãƒœã‚¿ãƒ³: PCã§æ‚£è€…å‘ã‘ç”»é¢ã‚’ç¢ºèª -->
                    <button onclick="showPatientView()" class="primary-action-button disabled" id="patient-view-btn" disabled>
                        <span class="button-icon">ğŸ‘ï¸</span>
                        <span class="button-text">
                            <strong>æ‚£è€…ç”¨ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º</strong>
                            <small>PCã§æ‚£è€…å‘ã‘ç”»é¢ã‚’ç¢ºèª</small>
                        </span>
                    </button>
                </div>
            </div>
            
            <!-- ã€ä¸­é‡è¦ã€‘EHRæ¥ç¶šçŠ¶æ…‹ - ä¸­ã‚µã‚¤ã‚º -->
            <div class="ehr-connection-status priority-medium">
                <h4>ğŸ”— é›»å­ã‚«ãƒ«ãƒ†ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶š(ä»®)</h4>
                <div class="connection-info">
                    <div class="connection-indicator">
                        <span class="status-dot connected"></span>
                        <span>FHIRæ¨™æº–å‹é›»å­ã‚«ãƒ«ãƒ†ã‚·ã‚¹ãƒ†ãƒ ã«æ¥ç¶šä¸­</span>
                    </div>
                    <div class="current-session">
                        <strong>ç¾åœ¨ã®è¨ºå¯Ÿã‚»ãƒƒã‚·ãƒ§ãƒ³:</strong> å¤–æ¥è¨ºå¯Ÿå®¤A - 2025å¹´9æœˆ15æ—¥ 15:30
                    </div>
                </div>
            </div>
            
            <!-- ã€ä½é‡è¦ã€‘æ“ä½œå±¥æ­´ - å°ã‚µã‚¤ã‚º -->
            <div class="activity-feed priority-low">
                <h5>ğŸ“ æœ€è¿‘ã®æ“ä½œ</h5>
                <div id="operation-history"></div>
            </div>
            
            
            <!-- ã€ä½é‡è¦ã€‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ - å°ã‚µã‚¤ã‚º -->
            <div class="security-verification-small priority-low">
                <h5>ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼</h5>
                <p>ã‚·ã‚¹ãƒ†ãƒ ã®æš—å·åŒ–é€šä¿¡ãƒ»é›»å­ç½²åãƒ»ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ã‚’æ¤œè¨¼ã—ã¾ã™</p>
                <button onclick="toggleSecurityVerification()" class="security-button">ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚’å®Ÿè¡Œ</button>
            </div>
            
        </div>
    </div>
    
    <!-- åŒæ„å–å¾—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="consentModal" class="consent-modal" style="display: none;">
        <div class="consent-modal-content">
            <h2>ğŸ”’ åŒ»ç™‚æƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦</h2>
            <p>ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ã‚ãªãŸã®åŒ»ç™‚æƒ…å ±ã‚’å®‰å…¨ã«ç®¡ç†ã—ã€å¿…è¦ã«å¿œã˜ã¦åŒ»ç™‚å¾“äº‹è€…ã¨å…±æœ‰ã—ã¾ã™ã€‚</p>
            
            <div class="consent-options">
                <h3>æƒ…å ±å…±æœ‰ã®åŒæ„</h3>
                <label style="display: flex; align-items: center; margin: 10px 0;">
                    <input type="checkbox" id="consent-family" style="margin-right: 10px;">
                    <span>å®¶æ—ã¨ã®æƒ…å ±å…±æœ‰ã‚’è¨±å¯ã™ã‚‹</span>
                </label>
                <label style="display: flex; align-items: center; margin: 10px 0;">
                    <input type="checkbox" id="consent-emergency" checked style="margin-right: 10px;">
                    <span>ç·Šæ€¥æ™‚ã®æƒ…å ±å…±æœ‰ã‚’è¨±å¯ã™ã‚‹</span>
                </label>
                <label style="display: flex; align-items: center; margin: 10px 0;">
                    <input type="checkbox" id="consent-research" style="margin-right: 10px;">
                    <span>ç ”ç©¶ç›®çš„ã§ã®æƒ…å ±åˆ©ç”¨ã‚’è¨±å¯ã™ã‚‹</span>
                </label>
            </div>
            
            <div class="consent-buttons">
                <button onclick="acceptConsent()" class="consent-accept-btn">åŒæ„ã—ã¦ç¶šè¡Œ</button>
                <button onclick="declineConsent()" class="consent-decline-btn">åŒæ„ã—ãªã„</button>
            </div>
        </div>
    </div>
    


    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="security-verification-section" class="security-verification-container" style="display: none;">
        <div class="security-content">
            <div class="verification-section">
                <div class="verification-header">
                    <h2>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã®å®Ÿè¡Œ</h2>
                    <button onclick="toggleSecurityVerification()" class="close-security-btn">Ã—</button>
                </div>
                <p>ä»¥ä¸‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é …ç›®ã‚’æ¤œè¨¼ã—ã¾ã™ï¼š</p>
                <ul class="security-features-list">
                    <li><strong>ãƒ‡ãƒ¢ç”¨éµã‚·ã‚¹ãƒ†ãƒ ï¼ˆRSA 2048-bitï¼‰</strong> - ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ã¨ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã«ä½¿ç”¨ã€‚æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã®æ”¹ã–ã‚“ã‚’æ¤œå‡ºã—ã€ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨æ€§ã‚’ä¿è¨¼ã—ã¾ã™ã€‚</li>
                    <li><strong>æ‚£è€…ãƒ‡ãƒ¼ã‚¿ç½²åæ¤œè¨¼</strong> - ãƒ‡ãƒ¼ã‚¿ã®æ”¹ã–ã‚“æ¤œçŸ¥ã¨å®Œå…¨æ€§ä¿è¨¼ã€‚ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãŒæ”¹ã–ã‚“ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚</li>
                    <li><strong>ç›£æŸ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ </strong> - å…¨ã¦ã®æ“ä½œã®è¨˜éŒ²ã¨è¿½è·¡å¯èƒ½æ€§ã€‚èª°ãŒã„ã¤ä½•ã‚’ã—ãŸã‹ã‚’å®Œå…¨ã«è¨˜éŒ²ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®èª¿æŸ»ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚</li>
                    <li><strong>æš—å·åŒ–ã‚·ã‚¹ãƒ†ãƒ </strong> - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ä¿è­·ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®æš—å·åŒ–ã«ã‚ˆã‚Šã€æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«ä¿å­˜ã—ã¾ã™ã€‚</li>
                    <li><strong>WebAuthnèªè¨¼ã‚·ã‚¹ãƒ†ãƒ </strong> - ç”Ÿä½“èªè¨¼ã«ã‚ˆã‚‹å¼·å›ºãªèªè¨¼ã€‚æŒ‡ç´‹ã‚„é¡”èªè¨¼ã«ã‚ˆã‚Šã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ä¾å­˜ã—ãªã„å®‰å…¨ãªèªè¨¼ã‚’å®Ÿç¾ã—ã¾ã™ã€‚</li>
                    <li><strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</strong> - ã‚»ã‚­ãƒ¥ã‚¢ãªã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡ã€‚é©åˆ‡ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã«ã‚ˆã‚Šã€ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²æ­¢ã—ã¾ã™ã€‚</li>
                </ul>
                
                <button class="start-verification-btn" onclick="startSecurityVerification()" id="startSecurityBtn">
                    ğŸš€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚’é–‹å§‹
                </button>
            </div>

            <div class="verification-loading" id="securityLoading" style="display: none;">
                <p><strong>ğŸ”„ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚’å®Ÿè¡Œä¸­...</strong></p>
                <p>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
            </div>

            <div class="verification-results" id="securityResults" style="display: none;">
                <div class="overall-security-status" id="overallSecurityStatus"></div>
                
                <div id="securityCheckResults"></div>
                
                <div class="security-summary" id="securitySummary"></div>
            </div>
        </div>
    </div>

    <!-- ======================================== -->
    <!-- JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ -->
    <!-- ======================================== -->
    <script src="{{ url_for('static', filename='script_fixed.js') }}"></script>
    <script src="{{ url_for('static', filename='accessibility.js') }}"></script>
    <script src="{{ url_for('static', filename='google_translate.js') }}"></script>
    
    <!-- ======================================== -->
    <!-- æ‚£è€…é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <!-- ======================================== -->
    <div id="patient-selection-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ‘¤ æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
                <span class="close" onclick="closePatientSelectionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>æ¨¡æ“¬é›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚æ‚£è€…ã‚’é¸æŠã—ã¦ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                <div id="patient-list" class="patient-list">
                    <!-- æ‚£è€…ä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closePatientSelectionModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ======================================== -->
    <!-- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³JavaScript: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£æ©Ÿèƒ½ -->
    <!-- ======================================== -->
    <script>
        /**
         * æ‚£è€…é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
         */
        async function showPatientSelectionModal() {
            console.log('ğŸ”„ æ‚£è€…é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºä¸­...');
            
            const modal = document.getElementById('patient-selection-modal');
            const patientList = document.getElementById('patient-list');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            patientList.innerHTML = '<div style="text-align: center; padding: 20px;">æ¨¡æ“¬é›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>';
            modal.style.display = 'block';
            
            try {
                // æ¨¡æ“¬é›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰æ‚£è€…ä¸€è¦§ã‚’å–å¾—
                const response = await fetch('/api/dummy-ehr/patients');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (data.success && data.patients) {
                    // æ‚£è€…ä¸€è¦§ã‚’è¡¨ç¤º
                    patientList.innerHTML = data.patients.map(patient => `
                        <div class="patient-item" onclick="selectPatient('${patient.patient_id}')">
                            <div class="patient-info">
                                <h4>${patient.name} (${patient.name_kana})</h4>
                                <p>æ‚£è€…ID: ${patient.patient_id} | ç”Ÿå¹´æœˆæ—¥: ${patient.birth_date} | æ€§åˆ¥: ${patient.gender}</p>
                                <p>è¡€æ¶²å‹: ${patient.blood_type} | ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼: ${patient.allergies}</p>
                            </div>
                            <div class="patient-actions">
                                <button class="btn btn-primary" onclick="event.stopPropagation(); selectPatient('${patient.patient_id}')">
                                    ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    patientList.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
                }
            } catch (error) {
                console.error('æ‚£è€…ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                patientList.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
            }
        }
        
        /**
         * æ‚£è€…é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
         */
        function closePatientSelectionModal() {
            document.getElementById('patient-selection-modal').style.display = 'none';
        }
        
        /**
         * æ‚£è€…ã‚’é¸æŠã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
         */
        async function selectPatient(patientId) {
            console.log('ğŸ”„ æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­:', patientId);
            
            try {
                // æ¨¡æ“¬é›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await fetch(`/api/dummy-ehr/patient/${patientId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (data.success && data.patient) {
                    // æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã‚¨ãƒªã‚¢ã«è¨­å®š
                    const patient = data.patient;
                    document.getElementById('doctor-patient-id').textContent = patient.patient_id || patientId;
                    document.getElementById('doctor-patient-name').textContent = patient.name || 'ä¸æ˜';
                    document.getElementById('doctor-patient-age').textContent = patient.age ? patient.age + 'æ­³' : 'ä¸æ˜';
                    document.getElementById('doctor-patient-gender').textContent = patient.gender || 'ä¸æ˜';
                    
                    // æ‚£è€…IDã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
                    sessionStorage.setItem('currentPatientId', patient.patient_id || patientId);
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    const patientStatus = document.querySelector('.patient-status');
                    if (patientStatus) {
                        patientStatus.textContent = `${patient.name}ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`;
                        patientStatus.style.background = 'rgba(40, 167, 69, 0.3)';
                    }
                    
                    // ä¾å­˜ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                    enableDataDependentButtons();
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    closePatientSelectionModal();
                    
                    console.log('âœ… æ‚£è€…ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', patient);
                } else {
                    alert('æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('æ‚£è€…ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        /**
         * ç¾åœ¨æ™‚åˆ»ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         * ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç¾åœ¨æ™‚åˆ»è¡¨ç¤ºã‚’1ç§’ã”ã¨ã«æ›´æ–°
         */
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = `ç¾åœ¨æ™‚åˆ»: ${timeString}`;
            }
        }
        
        /**
         * ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–å‡¦ç†
         * - ç¾åœ¨æ™‚åˆ»ã®è¡¨ç¤ºé–‹å§‹
         * - 1ç§’ã”ã¨ã®è‡ªå‹•æ›´æ–°è¨­å®š
         */
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            // 1ç§’ã”ã¨ã«æ™‚åˆ»ã‚’æ›´æ–°
            setInterval(updateCurrentTime, 1000);
        });
    </script>
</body>
</html>
