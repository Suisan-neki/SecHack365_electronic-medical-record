<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- 基本メタデータ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診療ディスプレイ</title>
    
    <!-- スタイルシートの読み込み -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='accessibility.css') }}">
    
    <!-- 患者選択モーダルのスタイル -->
    <style>
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            opacity: 0.7;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 20px;
            text-align: right;
            border-top: 1px solid #e0e0e0;
        }
        
        .patient-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .patient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .patient-item:hover {
            background: #f0f8ff;
            border-color: #667eea;
        }
        
        .patient-info h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 16px;
        }
        
        .patient-info p {
            margin: 2px 0;
            color: #666;
            font-size: 14px;
        }
        
        .patient-actions {
            margin-left: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
    </style>
</head>
<body {% if current_user.is_authenticated %}data-user-role="{{ current_user.role }}"{% endif %}>
    <!-- ======================================== -->
    <!-- 医師向けプライベートビュー（メイン画面） -->
    <!-- ======================================== -->
    <div id="private-view">
        <!-- ヘッダーセクション: ユーザー情報とナビゲーションボタン -->
        <div class="user-header">
            <!-- 左側: システム名とユーザー情報 -->
            <div class="user-info">
                <h2>患者情報共有システム</h2>
                {% if current_user.is_authenticated %}
                <p class="user-status">
                    ログイン中: <strong>{{ current_user.id }}</strong> 
                    ({{ current_user.role }})
                    {% if current_user.mfa_enabled %}
                    <span class="mfa-badge">MFA有効</span>
                    {% endif %}
                </p>
                {% else %}
                <p class="user-status">ログインが必要です</p>
                {% endif %}
            </div>
            <!-- 右側: アクションボタンとユーティリティ -->
            <div class="user-actions">
                <!-- 現在時刻表示 -->
                <div class="header-info">
                    <div id="current-time">現在時刻: 読み込み中...</div>
                </div>
                <!-- ページ更新ボタン -->
                <button onclick="location.reload()" class="refresh-btn">🔄 更新</button>
                <!-- 認証状態に応じたナビゲーションボタン -->
                {% if current_user.is_authenticated %}
                    <!-- 管理者・医師向け機能 -->
                    {% if current_user.role == 'admin' or current_user.role == 'doctor' %}
                    <a href="{{ url_for('audit_dashboard') }}" class="nav-btn audit-btn">🔍 監査ログ</a>
                    {% endif %}
                    <!-- 認証済みユーザー向け機能 -->
                    <a href="{{ url_for('webauthn_management') }}" class="nav-btn webauthn-btn">🔧 WebAuthn管理</a>
                    <a href="{{ url_for('logout') }}" class="nav-btn logout-btn">ログアウト</a>
                {% else %}
                    <!-- 未認証ユーザー向け機能 -->
                    <a href="{{ url_for('webauthn_login') }}" class="nav-btn webauthn-login-btn">🔐 WebAuthn</a>
                    <a href="{{ url_for('login') }}" class="nav-btn login-btn">ログイン</a>
                {% endif %}
            </div>
        </div>
        
        <!-- メインタイトル -->
        <h1>🩺 医師向けプライベートビュー - 新しいシステムフロー</h1>
        
        <!-- ======================================== -->
        <!-- デバッグ情報セクション -->
        <!-- ======================================== -->
        <div style="background: #f0f8ff; border: 1px solid #bee3f8; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 10px 0; color: #2b6cb0;">認証状態（デバッグ情報）</h3>
            <p style="margin: 5px 0; color: #2c5282;">
                <strong>認証状態:</strong> 
                {% if current_user.is_authenticated %}
                    ✅ ログイン済み
                {% else %}
                    ❌ 未ログイン
                {% endif %}
            </p>
            {% if current_user.is_authenticated %}
            <p style="margin: 5px 0; color: #2c5282;">
                <strong>ユーザーID:</strong> {{ current_user.id }}<br>
                <strong>役割:</strong> {{ current_user.role }}
            </p>
            {% endif %}
        </div>
        
        <!-- 古い認証フォームは新しいログインシステムに置き換えられました -->
        <div id="auth-section" style="display: none;">
            <!-- 非表示: 新しいFlask-Loginシステムを使用 -->
        </div>
        
        <!-- 古いヘッダーは削除（上の新しいヘッダーを使用） -->
        
        <div id="controls-section" style="display:block;">
            <!-- 【最重要】現在の診察患者情報 - 大サイズ -->
            <div class="patient-card priority-high">
                <div class="card-header">
                    <h2>🏥 現在の診察患者</h2>
                    <div class="patient-status">新しいシステムフローで医療記録を入力してください</div>
                </div>
                <div class="patient-details">
                    <div class="patient-detail-item">
                        <span class="detail-label">患者名</span>
                        <span class="detail-value" id="doctor-patient-name">「医療記録を入力」ボタンから新しいシステムフローを開始</span>
                    </div>
                    <div class="patient-detail-item">
                        <span class="detail-label">年齢・性別</span>
                        <span class="detail-value">
                            <span id="doctor-patient-age">-</span> / <span id="doctor-patient-gender">-</span>
                        </span>
                    </div>
                    <div class="patient-detail-item">
                        <span class="detail-label">患者ID</span>
                        <span class="detail-value" id="doctor-patient-id">-</span>
                    </div>
                </div>
            </div>
            
            <!-- ======================================== -->
            <!-- 主要操作ボタンセクション - 横並び3つ -->
            <!-- ======================================== -->
            <div class="action-buttons priority-high">
                <div class="button-row">
                    <!-- 医療記録入力ボタン: 新しいシステムフローで医療情報を入力 -->
                    <a href="{{ url_for('input_form') }}" class="primary-action-button" id="input-form-btn">
                        <span class="button-icon">📝</span>
                        <span class="button-text">
                            <strong>医療記録を入力</strong>
                            <small>新しいシステムフローで医療情報を入力・患者に表示</small>
                        </span>
                    </a>
                    <!-- 患者情報抽出ボタン: 模擬電子カルテから患者データを取得 -->
                    <button onclick="showPatientSelectionModal()" class="primary-action-button secondary" id="load-data-btn">
                        <span class="button-icon">📤</span>
                        <span class="button-text">
                            <strong>患者情報を抽出</strong>
                            <small>模擬電子カルテから患者データを選択・取得</small>
                        </span>
                    </button>
                    <!-- 患者用ビュー表示ボタン: PCで患者向け画面を確認 -->
                    <button onclick="showPatientView()" class="primary-action-button disabled" id="patient-view-btn" disabled>
                        <span class="button-icon">👁️</span>
                        <span class="button-text">
                            <strong>患者用ビューを表示</strong>
                            <small>PCで患者向け画面を確認</small>
                        </span>
                    </button>
                </div>
            </div>
            
            <!-- 【中重要】EHR接続状態 - 中サイズ -->
            <div class="ehr-connection-status priority-medium">
                <h4>🔗 電子カルテシステム接続(仮)</h4>
                <div class="connection-info">
                    <div class="connection-indicator">
                        <span class="status-dot connected"></span>
                        <span>FHIR標準型電子カルテシステムに接続中</span>
                    </div>
                    <div class="current-session">
                        <strong>現在の診察セッション:</strong> 外来診察室A - 2025年9月15日 15:30
                    </div>
                </div>
            </div>
            
            <!-- 【低重要】操作履歴 - 小サイズ -->
            <div class="activity-feed priority-low">
                <h5>📝 最近の操作</h5>
                <div id="operation-history"></div>
            </div>
            
            
            <!-- 【低重要】セキュリティ検証 - 小サイズ -->
            <div class="security-verification-small priority-low">
                <h5>🔐 セキュリティ検証</h5>
                <p>システムの暗号化通信・電子署名・データ完全性を検証します</p>
                <button onclick="toggleSecurityVerification()" class="security-button">🔒 セキュリティ検証を実行</button>
            </div>
            
        </div>
    </div>
    
    <!-- 同意取得ポップアップ -->
    <div id="consentModal" class="consent-modal" style="display: none;">
        <div class="consent-modal-content">
            <h2>🔒 医療情報の取り扱いについて</h2>
            <p>このシステムでは、あなたの医療情報を安全に管理し、必要に応じて医療従事者と共有します。</p>
            
            <div class="consent-options">
                <h3>情報共有の同意</h3>
                <label style="display: flex; align-items: center; margin: 10px 0;">
                    <input type="checkbox" id="consent-family" style="margin-right: 10px;">
                    <span>家族との情報共有を許可する</span>
                </label>
                <label style="display: flex; align-items: center; margin: 10px 0;">
                    <input type="checkbox" id="consent-emergency" checked style="margin-right: 10px;">
                    <span>緊急時の情報共有を許可する</span>
                </label>
                <label style="display: flex; align-items: center; margin: 10px 0;">
                    <input type="checkbox" id="consent-research" style="margin-right: 10px;">
                    <span>研究目的での情報利用を許可する</span>
                </label>
            </div>
            
            <div class="consent-buttons">
                <button onclick="acceptConsent()" class="consent-accept-btn">同意して続行</button>
                <button onclick="declineConsent()" class="consent-decline-btn">同意しない</button>
            </div>
        </div>
    </div>
    


    <!-- セキュリティ検証セクション -->
    <div id="security-verification-section" class="security-verification-container" style="display: none;">
        <div class="security-content">
            <div class="verification-section">
                <div class="verification-header">
                    <h2>セキュリティ検証の実行</h2>
                    <button onclick="toggleSecurityVerification()" class="close-security-btn">×</button>
                </div>
                <p>以下のセキュリティ項目を検証します：</p>
                <ul class="security-features-list">
                    <li><strong>デモ用鍵システム（RSA 2048-bit）</strong> - データの暗号化とデジタル署名に使用。患者データの改ざんを検出し、データの完全性を保証します。</li>
                    <li><strong>患者データ署名検証</strong> - データの改ざん検知と完全性保証。デジタル署名により、データが改ざんされていないことを確認できます。</li>
                    <li><strong>監査ログシステム</strong> - 全ての操作の記録と追跡可能性。誰がいつ何をしたかを完全に記録し、セキュリティインシデントの調査を可能にします。</li>
                    <li><strong>暗号化システム</strong> - ユーザーデータの暗号化保護。パスワードベースの暗号化により、機密データを安全に保存します。</li>
                    <li><strong>WebAuthn認証システム</strong> - 生体認証による強固な認証。指紋や顔認証により、パスワードに依存しない安全な認証を実現します。</li>
                    <li><strong>セッション管理</strong> - セキュアなセッション制御。適切なセッションタイムアウトとトークン管理により、不正アクセスを防止します。</li>
                </ul>
                
                <button class="start-verification-btn" onclick="startSecurityVerification()" id="startSecurityBtn">
                    🚀 セキュリティ検証を開始
                </button>
            </div>

            <div class="verification-loading" id="securityLoading" style="display: none;">
                <p><strong>🔄 セキュリティ検証を実行中...</strong></p>
                <p>しばらくお待ちください...</p>
            </div>

            <div class="verification-results" id="securityResults" style="display: none;">
                <div class="overall-security-status" id="overallSecurityStatus"></div>
                
                <div id="securityCheckResults"></div>
                
                <div class="security-summary" id="securitySummary"></div>
            </div>
        </div>
    </div>

    <!-- ======================================== -->
    <!-- JavaScriptファイルの読み込み -->
    <!-- ======================================== -->
    <script src="{{ url_for('static', filename='script_fixed.js') }}"></script>
    <script src="{{ url_for('static', filename='accessibility.js') }}"></script>
    <script src="{{ url_for('static', filename='google_translate.js') }}"></script>
    
    <!-- ======================================== -->
    <!-- 患者選択モーダル -->
    <!-- ======================================== -->
    <div id="patient-selection-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>👤 患者を選択してください</h3>
                <span class="close" onclick="closePatientSelectionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>模擬電子カルテから患者データを取得します。患者を選択して「データを取得」ボタンを押してください。</p>
                <div id="patient-list" class="patient-list">
                    <!-- 患者一覧がここに動的に追加されます -->
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closePatientSelectionModal()" class="btn btn-secondary">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- ======================================== -->
    <!-- インラインJavaScript: ユーティリティ機能 -->
    <!-- ======================================== -->
    <script>
        /**
         * 患者選択モーダルを表示
         */
        async function showPatientSelectionModal() {
            console.log('🔄 患者選択モーダルを表示中...');
            
            const modal = document.getElementById('patient-selection-modal');
            const patientList = document.getElementById('patient-list');
            
            // ローディング表示
            patientList.innerHTML = '<div style="text-align: center; padding: 20px;">模擬電子カルテから患者データを取得中...</div>';
            modal.style.display = 'block';
            
            try {
                // 模擬電子カルテから患者一覧を取得
                const response = await fetch('/api/dummy-ehr/patients');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (data.success && data.patients) {
                    // 患者一覧を表示
                    patientList.innerHTML = data.patients.map(patient => `
                        <div class="patient-item" onclick="selectPatient('${patient.patient_id}')">
                            <div class="patient-info">
                                <h4>${patient.name} (${patient.name_kana})</h4>
                                <p>患者ID: ${patient.patient_id} | 生年月日: ${patient.birth_date} | 性別: ${patient.gender}</p>
                                <p>血液型: ${patient.blood_type} | アレルギー: ${patient.allergies}</p>
                            </div>
                            <div class="patient-actions">
                                <button class="btn btn-primary" onclick="event.stopPropagation(); selectPatient('${patient.patient_id}')">
                                    データを取得
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    patientList.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">患者データを取得できませんでした</div>';
                }
            } catch (error) {
                console.error('患者一覧取得エラー:', error);
                patientList.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">エラー: ' + error.message + '</div>';
            }
        }
        
        /**
         * 患者選択モーダルを閉じる
         */
        function closePatientSelectionModal() {
            document.getElementById('patient-selection-modal').style.display = 'none';
        }
        
        /**
         * 患者を選択してデータを取得
         */
        async function selectPatient(patientId) {
            console.log('🔄 患者データを取得中:', patientId);
            
            try {
                // 模擬電子カルテから患者データを取得
                const response = await fetch(`/api/dummy-ehr/patient/${patientId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (data.success && data.patient) {
                    // 患者データを表示エリアに設定
                    const patient = data.patient;
                    document.getElementById('doctor-patient-id').textContent = patient.patient_id || patientId;
                    document.getElementById('doctor-patient-name').textContent = patient.name || '不明';
                    document.getElementById('doctor-patient-age').textContent = patient.age ? patient.age + '歳' : '不明';
                    document.getElementById('doctor-patient-gender').textContent = patient.gender || '不明';
                    
                    // 患者IDをセッションに保存
                    sessionStorage.setItem('currentPatientId', patient.patient_id || patientId);
                    
                    // 成功メッセージ
                    const patientStatus = document.querySelector('.patient-status');
                    if (patientStatus) {
                        patientStatus.textContent = `${patient.name}のデータを取得しました`;
                        patientStatus.style.background = 'rgba(40, 167, 69, 0.3)';
                    }
                    
                    // 依存ボタンを有効化
                    enableDataDependentButtons();
                    
                    // モーダルを閉じる
                    closePatientSelectionModal();
                    
                    console.log('✅ 患者データ取得成功:', patient);
                } else {
                    alert('患者データの取得に失敗しました: ' + (data.error || '不明なエラー'));
                }
            } catch (error) {
                console.error('患者データ取得エラー:', error);
                alert('患者データの取得中にエラーが発生しました: ' + error.message);
            }
        }

        /**
         * 現在時刻を更新する関数
         * ヘッダーの現在時刻表示を1秒ごとに更新
         */
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = `現在時刻: ${timeString}`;
            }
        }
        
        /**
         * ページ読み込み時の初期化処理
         * - 現在時刻の表示開始
         * - 1秒ごとの自動更新設定
         */
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            // 1秒ごとに時刻を更新
            setInterval(updateCurrentTime, 1000);
        });
    </script>
</body>
</html>
